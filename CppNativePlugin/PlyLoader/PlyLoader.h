#pragma once

#include <vector>
#include <string>
#include "ml_mesh_type.h"

using namespace std;

typedef float Float;
/* Useful Eigen typedefs based on the current precision */
typedef Eigen::Matrix<uint32_t, Eigen::Dynamic, Eigen::Dynamic> MatrixXu;
typedef Eigen::Matrix<Float, 3, Eigen::Dynamic>					Matrix3Xf;
typedef Eigen::Matrix<unsigned short, 3, Eigen::Dynamic>		Matrix3Xus;
typedef Eigen::Matrix<uint32_t, 3, Eigen::Dynamic>		Matrix3Xu;
typedef Eigen::Matrix<unsigned char, 3, Eigen::Dynamic>		Matrix3Xuc;
typedef Eigen::Matrix<uint32_t, 3, Eigen::Dynamic>		Matrix3Xu;


class PlyFileObject
{
public:
	enum MeshElement {
		MM_NONE = 0x00000000,
		MM_VERTCOORD = 0x00000001,
		MM_VERTNORMAL = 0x00000002,
		MM_VERTFLAG = 0x00000004,
		MM_VERTCOLOR = 0x00000008,
		MM_VERTQUALITY = 0x00000010,
		MM_VERTMARK = 0x00000020,
		MM_VERTFACETOPO = 0x00000040,
		MM_VERTCURV = 0x00000080,
		MM_VERTCURVDIR = 0x00000100,
		MM_VERTRADIUS = 0x00000200,
		MM_VERTTEXCOORD = 0x00000400,
		MM_VERTNUMBER = 0x00000800,

		MM_FACEVERT = 0x00001000,
		MM_FACENORMAL = 0x00002000,
		MM_FACEFLAG = 0x00004000,
		MM_FACECOLOR = 0x00008000,
		MM_FACEQUALITY = 0x00010000,
		MM_FACEMARK = 0x00020000,
		MM_FACEFACETOPO = 0x00040000,
		MM_FACENUMBER = 0x00080000,
		MM_FACECURVDIR = 0x00100000,

		MM_WEDGTEXCOORD = 0x00200000,
		MM_WEDGNORMAL = 0x00400000,
		MM_WEDGCOLOR = 0x00800000,

		// 	Selection
		MM_VERTFLAGSELECT = 0x01000000,
		MM_FACEFLAGSELECT = 0x02000000,

		// Per Mesh Stuff....
		MM_CAMERA = 0x08000000,
		MM_TRANSFMATRIX = 0x10000000,
		MM_COLOR = 0x20000000,
		MM_POLYGONAL = 0x40000000,
		MM_UNKNOWN = 0x80000000,

		MM_ALL = 0xffffffff
	};

	PlyFileObject(const char* fileName, int downsample = 0);
	vector<float> verts;
	vector<float> norms;
	vector<unsigned char> colors;
	vector<unsigned int> faces;
	vector<float> uvCoords;
	string textureName;
	CMeshO cm;

	MatrixXu F;
	Matrix3Xf V;
	Matrix3Xf N;
	Matrix3Xus Clab;
	Matrix3Xuc Crgb;

private:
	void Enable(int openingFileMask);
	void updateDataMask(int openingFileMask);
	void load_ply(const std::string &filename, MatrixXu &F, Matrix3Xf &V,
		Matrix3Xf &N, Matrix3Xus &Clab, Matrix3Xuc & Crgb, bool pointcloud);
};

extern "C" {
	__declspec(dllexport) PlyFileObject* LoadPly(const char* fileName);

	// try downsample when loading
	__declspec(dllexport) PlyFileObject* LoadPlyDownSample(const char* fileName, int downsample);

	__declspec(dllexport) void UnLoadPly(PlyFileObject* plyFile);

	__declspec(dllexport) float* GetPlyVerts(PlyFileObject* plyFile, unsigned int& count);

	__declspec(dllexport) float* GetPlyNormals(PlyFileObject* plyFile, unsigned int& count);

	__declspec(dllexport) unsigned char* GetPlyColors(PlyFileObject* plyFile, unsigned int& count);
	__declspec(dllexport) unsigned short* GetPlyLABColors(PlyFileObject* plyFile, unsigned int& count);

	__declspec(dllexport) unsigned int* GetPlyIndexs(PlyFileObject* plyFile, unsigned int& count);

	__declspec(dllexport) float* GetPlyUvs(PlyFileObject* plyFile, unsigned int& count);

	__declspec(dllexport) const char* GetPlyTextureName(PlyFileObject* plyFile);
};
